<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Simple eCommerce (Google Sheets + PWA)</title>

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0284C7">


<style>
:root {
  --bg: #0f172a;
  --card-bg: #fff;
  --text-dark: #071126;
  --muted: #475569;
  --accent: #0284C7;
  --btn-bg: #0284C7;
  --btn-text: #fff;
}

body {
  font-family: system-ui, Arial, sans-serif;
  background: var(--bg);
  color: #e6eef8;
  padding: 20px;
  margin: 0;
}
.container { max-width: 1200px; margin: auto; }
h1 { margin-bottom: 10px; color: #eaf6ff; }
.notice { color: #cfefff; margin-bottom: 10px; }

/* GRID */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 18px;
  margin-top: 15px;
}

/* CARD */
.card {
  background: var(--card-bg);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(2,132,199,0.12);
  display: flex;
  flex-direction: column;
  transition: transform .18s ease, box-shadow .18s ease;
}
.card:hover { transform: translateY(-6px); box-shadow: 0 20px 48px rgba(2,132,199,0.18); }

.card-head {
  padding: 10px 14px;
  border-bottom: 1px solid rgba(2,132,199,0.06);
  font-weight: 700;
  color: var(--text-dark);
  font-size: 15px;
}

.img-wrap { width: 100%; background: #f1f5f9; position: relative; }
.thumb {
  width: 100%;
  height: 200px;
  object-fit: cover;
  cursor: zoom-in;
}
.placeholder {
  width: 100%; height: 200px;
  display: flex; align-items: center; justify-content: center;
  background: linear-gradient(90deg,#eef4fb,#f8fbff);
  color: #94a3b8; font-weight: 600;
}

.card-body {
  padding: 12px 14px;
  display: flex; flex-direction: column;
  gap: 8px; flex: 1;
}

.price { font-weight: 700; color: var(--text-dark); font-size: 16px; }
.desc {
  color: var(--muted);
  font-size: 14px; line-height: 1.4;
  max-height: 3.6em; overflow: hidden;
}
.btn-add {
  background: var(--btn-bg);
  color: var(--btn-text);
  border: none; border-radius: 6px;
  cursor: pointer; padding: 8px 10px;
  font-weight: 600; margin-top: auto;
  transition: background 0.2s ease;
}
.btn-add:hover { background: #0369A1; }

/* CART PANEL */
.cart-panel {
  position: fixed;
  top: 0; right: 0;
  width: 320px; height: 100%;
  background: #1E293B;
  color: #fff;
  box-shadow: -4px 0 10px rgba(0,0,0,0.3);
  transform: translateX(100%);
  transition: transform 0.3s ease;
  display: flex; flex-direction: column;
  padding: 20px;
  z-index: 1000;
}
.cart-panel.open { transform: translateX(0); }
.cart-header {
  display: flex; justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}
.cart-items { flex: 1; overflow-y: auto; margin-bottom: 15px; }
.cart-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
.cart-total { font-weight: 700; margin-bottom: 10px; }
.btn-checkout {
  background: var(--accent);
  color: #fff; border: none; border-radius: 6px;
  padding: 10px; cursor: pointer; font-weight: 600;
}
.btn-checkout:hover { background: #0369A1; }

#btnCart {
  position: fixed;
  top: 20px; right: 20px;
  background: var(--accent);
  color: #fff;
  border: none; border-radius: 50px;
  padding: 10px 16px;
  font-weight: 700;
  cursor: pointer;
  z-index: 1100;
}
#btnCart:hover { background: #0369A1; }

/* IMAGE MODAL */
.img-modal {
  display: none;
  position: fixed;
  z-index: 2000;
  inset: 0;
  background: rgba(0,0,0,0.9);
  align-items: center;
  justify-content: center;
  overflow: hidden;
  animation: fadeIn 0.3s ease;
}
.img-modal[aria-hidden="false"] { display: flex; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

.img-modal-content {
  position: relative;
  width: 100%; height: 100%;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden;
  touch-action: none;
}
.img-modal-content img {
  max-width: 90%;
  max-height: 90%;
  transform-origin: center center;
  transition: transform 0.2s ease;
  cursor: grab;
}
.img-controls {
  position: absolute; top: 15px; right: 15px;
  display: flex; gap: 10px;
}
.img-btn {
  background: rgba(255,255,255,0.1);
  color: white; border: 1px solid rgba(255,255,255,0.2);
  border-radius: 8px; padding: 6px 10px;
  cursor: pointer;
  font-weight: 600;
}
.img-btn:hover { background: rgba(255,255,255,0.3); }

@media (max-width:420px) {
  .thumb { height: 160px; }
  #btnCart { padding: 8px 12px; font-size: 14px; }
}
</style>
</head>

<body>
  <div class="container">
    <h1>Shop Products</h1>
    <div id="notice" class="notice">Loading…</div>
    <div id="grid" class="grid"></div>
  </div>

  <!-- CART BUTTON -->
  <button id="btnCart" aria-label="Open shopping cart">Cart (0)</button>

  <!-- CART PANEL -->
  <div id="cartPanel" class="cart-panel" aria-hidden="true">
    <div class="cart-header">
      <h2>Shopping Cart</h2>
      <button id="btnCloseCart" aria-label="Close cart" style="background:none;border:none;color:white;font-size:18px;cursor:pointer;">✕</button>
    </div>
    <div id="cartItems" class="cart-items"></div>
    <div id="cartTotal" class="cart-total">Rs. 0.00</div>
    <button id="btnCheckout" class="btn-checkout">Checkout</button>
  </div>

  <!-- IMAGE VIEWER MODAL -->
  <div id="imgModal" class="img-modal" aria-hidden="true">
    <div class="img-modal-content" role="dialog" aria-modal="true" aria-label="Product image viewer">
      <div class="img-controls">
        <button id="btnResetZoom" class="img-btn" aria-label="Reset zoom">Reset</button>
        <button id="btnCloseImg" class="img-btn" aria-label="Close image viewer">✕</button>
      </div>
      <img id="modalImage" alt="Product Image">
    </div>
  </div>

<script>
/* === CONFIG === */
const SPREADSHEET_ID = '1EVx4ZUqKdpKctQwhnbuH6s2vA9Sx3kwnFop0NQID2eI';
const GID = '0';

/* === HELPERS === */
function normalizeDriveURL(url){
  if(!url) return '';
  if(/\.(png|jpe?g|gif|webp|svg)(\?.*)?$/i.test(url)) return url;
  let m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
  if(m && m[1]) return `https://drive.google.com/thumbnail?id=${m[1]}&sz=w1000`;
  m = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
  if(m && m[1]) return `https://drive.google.com/thumbnail?id=${m[1]}&sz=w1000`;
  return url;
}
function extractImgSrcFromHtml(html){
  const m = html.match(/src=['"]([^'"]+)['"]/i);
  return m ? m[1] : '';
}
function gvizToObjects(gviz){
  const cols = gviz.table.cols.map(c=>c.label||'');
  return gviz.table.rows.map(r=>{
    const obj={};
    r.c.forEach((c,i)=>{ obj[cols[i]] = c ? (c.f && c.f.includes('<img') ? extractImgSrcFromHtml(c.f) : c.v) : ''; });
    return obj;
  });
}

/* === LOAD SHEET === */
window.google = { visualization: { Query: { setResponse(resp){
  const items = gvizToObjects(resp);
  document.getElementById('notice').textContent = `Loaded ${items.length} items.`;
  renderTiles(items);
}}}};
(function loadSheet(){
  const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json`;
  const s = document.createElement('script');
  s.src = url; s.onerror = ()=>{document.getElementById('notice').textContent='Failed to load sheet.';};
  document.head.appendChild(s);
})();

/* === CART === */
const cart = [];
const btnCart = document.getElementById('btnCart');
const cartPanel = document.getElementById('cartPanel');
const cartItemsEl = document.getElementById('cartItems');
const cartTotalEl = document.getElementById('cartTotal');

function updateCart(){
  cartItemsEl.innerHTML = '';
  let total = 0;
  if(cart.length===0){
    cartItemsEl.textContent='No items in cart.';
  } else {
    cart.forEach((item,i)=>{
      const div=document.createElement('div');
      div.className='cart-item';
      div.innerHTML=`<span>${item.name}</span><span>Rs. ${item.price}</span>`;
      cartItemsEl.appendChild(div);
      total+=parseFloat(item.price)||0;
    });
  }
  cartTotalEl.textContent = `Rs. ${total.toFixed(2)}`;
  btnCart.textContent = `Cart (${cart.length})`;
}

btnCart.addEventListener('click',()=>{
  cartPanel.classList.add('open');
  cartPanel.setAttribute('aria-hidden','false');
});
document.getElementById('btnCloseCart').addEventListener('click',()=>{
  cartPanel.classList.remove('open');
  cartPanel.setAttribute('aria-hidden','true');
});

/* === RENDER TILES === */
function renderTiles(rows){
  const grid=document.getElementById('grid');
  grid.innerHTML='';
  const keys = Object.keys(rows[0]);
  const nameKey = keys.find(k=>/name/i.test(k));
  const priceKey = keys.find(k=>/price/i.test(k));
  const imageKey = keys.find(k=>/image/i.test(k));
  const descKey = keys.find(k=>/desc/i.test(k));

  rows.forEach((r,idx)=>{
    const card=document.createElement('article');
    card.className='card';
    card.innerHTML=`
      <div class="card-head">${r[nameKey]}</div>
      <div class="img-wrap">
        ${r[imageKey] ? `<img src="${normalizeDriveURL(r[imageKey])}" alt="${r[nameKey]}" class="thumb">` : `<div class="placeholder">No image</div>`}
      </div>
      <div class="card-body">
        <div class="price">Rs. ${r[priceKey]||''}</div>
        <div class="desc">${r[descKey]||''}</div>
        <button class="btn-add" data-id="${idx}">Add to Cart</button>
      </div>`;
    grid.appendChild(card);

    card.querySelector('.btn-add').addEventListener('click',()=>{
      cart.push({name:r[nameKey],price:r[priceKey]});
      updateCart();
    });
  });
}

/* === IMAGE MODAL with ZOOM === */
const imgModal=document.getElementById('imgModal');
const modalImage=document.getElementById('modalImage');
const btnCloseImg=document.getElementById('btnCloseImg');
const btnResetZoom=document.getElementById('btnResetZoom');
let scale=1, startX=0, startY=0, originX=0, originY=0, isPanning=false;

document.addEventListener('click',e=>{
  if(e.target.classList.contains('thumb')){
    modalImage.src=e.target.src;
    scale=1; originX=0; originY=0;
    modalImage.style.transform=`scale(${scale}) translate(0px,0px)`;
    imgModal.setAttribute('aria-hidden','false');
    document.body.style.overflow='hidden';
  }
});
btnCloseImg.addEventListener('click',()=>{
  imgModal.setAttribute('aria-hidden','true');
  document.body.style.overflow='';
});
btnResetZoom.addEventListener('click',()=>{
  scale=1; originX=0; originY=0;
  modalImage.style.transform=`scale(1) translate(0px,0px)`;
});
imgModal.addEventListener('click',e=>{
  if(e.target===imgModal){
    imgModal.setAttribute('aria-hidden','true');
    document.body.style.overflow='';
  }
});
modalImage.addEventListener('wheel',e=>{
  e.preventDefault();
  const delta=e.deltaY>0?-0.1:0.1;
  scale=Math.min(Math.max(1,scale+delta),5);
  modalImage.style.transform=`scale(${scale}) translate(${originX}px,${originY}px)`;
});
modalImage.addEventListener('mousedown',e=>{
  e.preventDefault();
  isPanning=true;
  startX=e.clientX-originX;
  startY=e.clientY-originY;
  modalImage.style.cursor='grabbing';
});
window.addEventListener('mousemove',e=>{
  if(!isPanning) return;
  originX=e.clientX-startX;
  originY=e.clientY-startY;
  modalImage.style.transform=`scale(${scale}) translate(${originX}px,${originY}px)`;
});
window.addEventListener('mouseup',()=>{isPanning=false; modalImage.style.cursor='grab';});
let initialDistance=0,initialScale=1;
modalImage.addEventListener('touchstart',e=>{
  if(e.touches.length===2){
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    initialDistance=Math.sqrt(dx*dx+dy*dy);
    initialScale=scale;
  }
},{passive:false});
modalImage.addEventListener('touchmove',e=>{
  if(e.touches.length===2){
    e.preventDefault();
    const dx=e.touches[0].clientX-e.touches[1].clientX;
    const dy=e.touches[0].clientY-e.touches[1].clientY;
    const newDist=Math.sqrt(dx*dx+dy*dy);
    const zoomFactor=newDist/initialDistance;
    scale=Math.min(Math.max(1,initialScale*zoomFactor),5);
    modalImage.style.transform=`scale(${scale}) translate(${originX}px,${originY}px)`;
  }
},{passive:false});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape' && imgModal.getAttribute('aria-hidden')==='false'){
    imgModal.setAttribute('aria-hidden','true');
    document.body.style.overflow='';
  }
});
</script>
</body>
</html>
