<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My PWA App</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- PWA iOS Support -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    .thumb {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 8px;
      background: #f0f0f0;
    }
    .modal-bg {
      background: rgba(0,0,0,0.55);
    }
  </style>
</head>

<body class="bg-gray-100 p-4">

  <!-- Header -->
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-xl font-bold">My PWA App</h1>

    <div class="flex gap-2">
      <button onclick="refreshData()" class="bg-blue-600 text-white px-3 py-1 rounded shadow">Refresh</button>
      <button onclick="installPWA()" class="bg-green-600 text-white px-3 py-1 rounded shadow">Install App</button>
      <button onclick="openModal()" class="bg-gray-800 text-white px-3 py-1 rounded shadow">Add +</button>
    </div>
  </div>

  <!-- Cards Grid -->
  <div id="cards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>

  <!-- Modal -->
  <div id="modal" class="hidden fixed inset-0 flex justify-center items-center modal-bg">
    <div class="bg-white shadow-lg rounded-lg p-4 w-11/12 max-w-md">

      <h2 id="modalTitle" class="text-lg font-bold mb-3">Add New Item</h2>

      <input id="title" class="w-full border p-2 rounded mb-2" placeholder="Title" />
      <textarea id="description" class="w-full border p-2 rounded mb-2" placeholder="Description"></textarea>

      <label class="block">Select Image:</label>
      <input type="file" id="imageInput" accept="image/*" class="mb-2" />

      <img id="previewImg" class="w-full h-40 object-cover mb-3 rounded hidden" />

      <div class="flex justify-between">
        <button onclick="closeModal()" class="bg-gray-400 text-white px-3 py-1 rounded">Cancel</button>
        <button onclick="saveItem()" class="bg-blue-600 text-white px-3 py-1 rounded">Save</button>
      </div>

    </div>
  </div>

  <script>
    let deferredPrompt = null;
    let editId = null;
    let compressedImage = null;

    // GOOGLE APPS SCRIPT WEB APP URL
    const API_URL = "https://script.google.com/macros/s/AKfycbzIjMvgq2XHiSnU88wOKOnP3fcu5Vd2BStNiFHzXr-E3qgRARjbQezMSZwTUfNYEVm_CA/execL";   // <=== CHANGE THIS

    // REGISTER SERVICE WORKER
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("service-worker.js");
      });
    }

    // CAPTURE INSTALL PROMPT
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    function installPWA() {
      if (!deferredPrompt) {
        alert("Install option not available.");
        return;
      }
      deferredPrompt.prompt();
      deferredPrompt = null;
    }

    // OPEN/CLOSE MODAL
    function openModal(id = null) {
      editId = id;
      document.getElementById("modalTitle").innerText = id ? "Edit Item" : "Add New Item";

      if (id) {
        const item = window.loadedData.find(x => x.id === id);
        document.getElementById("title").value = item.title;
        document.getElementById("description").value = item.description;
        document.getElementById("previewImg").src = item.image;
        document.getElementById("previewImg").classList.remove("hidden");
      } else {
        document.getElementById("title").value = "";
        document.getElementById("description").value = "";
        document.getElementById("previewImg").classList.add("hidden");
        compressedImage = null;
      }

      document.getElementById("modal").classList.remove("hidden");
    }

    function closeModal() {
      document.getElementById("modal").classList.add("hidden");
    }

    // IMAGE INPUT + COMPRESSION
    document.getElementById("imageInput").addEventListener("change", async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const resized = await compressImage(file, 800, 800, 0.7);
      compressedImage = resized;

      const preview = document.getElementById("previewImg");
      preview.src = URL.createObjectURL(resized);
      preview.classList.remove("hidden");
    });

    // SIMPLE IMAGE COMPRESSION
    async function compressImage(file, maxW, maxH, quality) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => {
          let canvas = document.createElement("canvas");
          let ctx = canvas.getContext("2d");

          let ratio = Math.min(maxW / img.width, maxH / img.height);
          canvas.width = img.width * ratio;
          canvas.height = img.height * ratio;

          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          canvas.toBlob(blob => resolve(blob), "image/jpeg", quality);
        };
        img.src = URL.createObjectURL(file);
      });
    }

    // SAVE ITEM
    async function saveItem() {
      const title = document.getElementById("title").value.trim();
      const desc = document.getElementById("description").value.trim();

      if (!title) return alert("Title required");

      let form = new FormData();
      form.append("action", editId ? "update" : "add");
      form.append("id", editId || "");
      form.append("title", title);
      form.append("description", desc);

      if (compressedImage) form.append("image", compressedImage, "image.jpg");

      const res = await fetch(API_URL, { method: "POST", body: form });
      const json = await res.json();

      if (json.success) {
        closeModal();
        refreshData();
      } else {
        alert("Error saving item");
      }
    }

    // DELETE ITEM
    async function deleteItem(id) {
      if (!confirm("Delete this item?")) return;

      let form = new FormData();
      form.append("action", "delete");
      form.append("id", id);

      await fetch(API_URL, { method: "POST", body: form });
      refreshData();
    }

    // FETCH ITEMS
    async function refreshData() {
      const res = await fetch(API_URL + "?action=list");
      const json = await res.json();

      window.loadedData = json.data || [];
      renderCards();
    }

    // DISPLAY CARDS
    function renderCards() {
      const container = document.getElementById("cards");
      container.innerHTML = "";

      window.loadedData.forEach(item => {
        container.innerHTML += `
          <div class="bg-white p-3 rounded shadow">
            <img class="thumb" src="${item.image}" />
            <h3 class="mt-2 font-bold">${item.title}</h3>
            <p class="text-sm text-gray-600">${item.description}</p>

            <div class="flex gap-2 mt-2">
              <button onclick="openModal('${item.id}')" class="bg-blue-600 text-white px-2 py-1 rounded">Edit</button>
              <button onclick="deleteItem('${item.id}')" class="bg-red-600 text-white px-2 py-1 rounded">Delete</button>
            </div>
          </div>
        `;
      });
    }

    refreshData();
  </script>
</body>
</html>
